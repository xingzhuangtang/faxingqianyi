# 💇‍♂️ 发型迁移系统

专业的AI发型迁移系统，支持发型提取预览、人脸融合、素描风格转换。

---

## ✨ 功能特点

### 1. 发型提取预览
- 自动提取透明背景的纯发型
- 实时预览发型效果
- 帮助客户了解发型风格

### 2. 智能发型融合
- 使用阿里云人脸融合API
- 保持客户脸型不变
- 只改变发型
- 融合自然流畅

### 3. 素描风格转换
- 使用阿里云通义万相图生图API
- 多种素描风格可选（铅笔/详细/艺术/彩色）
- 高质量艺术化效果

### 4. 图片放大查看
- 点击任何图片可放大查看
- 查看细节
- 专业体验

---

## 🚀 快速开始

### 1. 安装依赖

```bash
pip3 install -r requirements.txt
```

### 2. 配置环境变量

```bash
export ALIBABA_CLOUD_ACCESS_KEY_ID='你的AccessKey ID'
export ALIBABA_CLOUD_ACCESS_KEY_SECRET='你的AccessKey Secret'
```

### 3. 启动应用

```bash
./start.sh
```

或者：

```bash
python3 app.py
```

### 4. 访问应用

打开浏览器访问：http://localhost:5002

---

## 📋 使用流程

```
步骤1: 上传发型参考图（完整人像）
   ↓
步骤2: 点击"提取发型" → 显示透明背景的纯发型预览
   ↓
步骤3: 上传客户照片
   ↓
步骤4: 选择参数
   - 模型版本（v1=脸型适配, v2=非脸型适配）
   - 是否启用素描效果
   - 素描风格
   ↓
步骤5: 点击"开始发型迁移"
   ↓
步骤6: 查看结果（点击图片可放大）
```

---

## 🎯 核心技术

### 1. 头发分割API
- 使用阿里云头发分割API
- 精确提取发型区域
- 生成透明背景PNG

### 2. 人脸融合API
- 使用阿里云人脸融合API
- 保持客户脸型
- 自然融合发型

### 3. 图生图API
- 使用阿里云通义万相图生图API（wan2.5-i2i-preview）
- 高质量素描转换
- 多种艺术风格

---

## 📁 项目结构

```
hairstyle-transfer/
├── app.py                          # 主应用
├── start.sh                        # 启动脚本
├── requirements.txt                # Python依赖
├── README.md                       # 项目说明
├── 使用指南.md                     # 详细使用指南
├── API配置说明.md                  # API配置说明
├── OSS配置说明.md                  # OSS配置说明
├── 头发分割API说明.md              # 头发分割API说明
├── 通义万相图生图API说明.md        # 图生图API说明
├── aliyun_hair_transfer_fixed.py   # 阿里云发型迁移核心模块
├── hair_segmentation.py            # 头发分割模块
├── bailian_sketch_converter.py     # 百炼素描转换模块
├── sketch_converter.py             # OpenCV素描转换模块（备用）
├── image_preprocessor.py           # 图像预处理模块
├── oss_upload_complete.py          # OSS上传模块
├── bailian_image2image.py          # 百炼图生图模块
├── shape_predictor_68_face_landmarks.dat  # 人脸特征点模型
├── templates/
│   └── index.html                  # 前端页面
└── static/
    ├── uploads/                    # 上传文件目录
    ├── results/                    # 结果文件目录
    └── hair_extracted/             # 提取的发型目录
```

---

## ⚙️ 配置说明

### 必需配置

1. **阿里云AccessKey**（必需）
   - 用于调用阿里云API
   - 设置环境变量：
     ```bash
     export ALIBABA_CLOUD_ACCESS_KEY_ID='你的key'
     export ALIBABA_CLOUD_ACCESS_KEY_SECRET='你的secret'
     ```

### 可选配置

2. **OSS配置**（可选）
   - 用于上传图片到OSS
   - 参考 `OSS配置说明.md`

---

## 🎨 素描风格说明

| 风格 | 描述 | 适用场景 |
|------|------|----------|
| pencil | 铅笔素描风格，细腻的线条，柔和的阴影 | 柔和自然的效果 |
| detailed | 细节丰富的素描画，强调轮廓和阴影 | 需要细节表现 |
| artistic | 艺术素描风格，黑白线条，对比强烈 | 艺术感强烈 |
| colored | 彩色素描风格，保留适当颜色 | 保留部分颜色 |

---

## 📊 API成本估算

### 头发分割API
- 价格：约 0.0025元/次
- 用途：提取发型预览

### 人脸融合API
- 价格：约 0.0025元/次
- 用途：发型融合

### 图生图API（素描转换）
- 价格：约 0.08元/次
- 用途：素描风格转换（可选）

**总成本**：
- 不启用素描：约 0.005元/次
- 启用素描：约 0.085元/次

---

## ❓ 常见问题

### 1. 提示"未检测到人脸"

**原因**：上传的图片中没有清晰的人脸

**解决**：
- 确保照片中有清晰的人脸
- 人脸不要太小或太模糊
- 避免侧脸或遮挡

### 2. 素描转换失败

**原因**：百炼API调用失败

**解决**：
- 检查DASHSCOPE_API_KEY是否设置
- 检查网络连接
- 系统会自动降级使用OpenCV素描转换

### 3. 融合效果不理想

**解决**：
- 尝试切换模型版本（v1 ↔ v2）
- v1：适配客户脸型
- v2：保持发型参考图的脸型

---

## 📝 更新日志

### v3.0 (2024-11-06)
- ✅ 集成发型提取预览功能
- ✅ 使用原始图片进行融合（提高稳定性）
- ✅ 集成百炼图生图API用于素描转换
- ✅ 添加图片放大功能
- ✅ 删除方案B，简化项目结构
- ✅ 清理无用文件，优化代码

### v2.0 (2024-11-05)
- ✅ 修复人脸融合逻辑
- ✅ 添加素描效果
- ✅ 优化错误处理

### v1.0 (2024-11-04)
- ✅ 基础发型迁移功能
- ✅ 阿里云API集成

---

## 📄 许可证

MIT License

---

## 🙏 致谢

- 阿里云人脸人体API
- 阿里云通义万相图生图API
- Flask Web框架
- OpenCV图像处理库

---

## 📧 联系方式

如有问题或建议，欢迎反馈！

---

**祝您使用愉快！** 💇‍♂️✨
