# 发型迁移应用使用指南

## 🎯 修复内容总结

### 问题1：API密钥配置
**原因**：您设置的环境变量名不正确
- ❌ 您设置的：`DASHSCOPE_API_KEY`
- ✅ 应该设置：`BAILIAN_API_KEY`

### 问题2：上传交互方式
**原来**：一次性多选上传
**现在**：点击添加模式，每次添加一张，最多3张

---

## 🚀 快速启动

### 方法1：使用启动脚本（推荐）

```bash
cd hairstyle-transfer
./start.sh
```

启动脚本会自动检查API密钥配置，并给出友好提示。

### 方法2：手动启动

```bash
# 1. 设置API密钥
export BAILIAN_API_KEY='sk-3b506952dc8847f2b46de0e2a8d303b0'

# 2. 激活虚拟环境（如果有）
source .venv/bin/activate

# 3. 启动应用
python app.py
```

### 方法3：永久配置API密钥

```bash
# 添加到 shell 配置文件
echo "export BAILIAN_API_KEY='sk-3b506952dc8847f2b46de0e2a8d303b0'" >> ~/.zshrc

# 重新加载配置
source ~/.zshrc

# 启动应用
python app.py
```

---

## ✅ 验证配置成功

启动应用后，查看终端输出：

### 配置成功（生产模式）
```
✅ 初始化百炼发型迁移服务 (理发师专用)
   API Key: sk-3b50695...
   Endpoint: https://dashscope.aliyuncs.com/...
✅ 当前运行在生产模式（百炼图生图）
💡 已设置环境变量 BAILIAN_API_KEY
```

### 配置失败（演示模式）
```
⚠️  警告: 未设置百炼API密钥
⚠️ 当前运行在演示模式（API密钥未设置）
💡 请设置环境变量 BAILIAN_API_KEY 以使用真实API
```

---

## 📱 使用应用

### 1. 访问网页
打开浏览器访问：http://localhost:5001

### 2. 上传发型参考图
- 点击左侧"选择发型图片"按钮
- 选择您设计的发型图片

### 3. 添加目标人脸图片（新功能）
- 点击右侧"+ 添加人脸图片"按钮
- 每次选择一张顾客的人脸照片
- 可以重复点击，最多添加3张
- 每张图片右上角有"×"删除按钮，可以单独删除

### 4. 调整参数
- **修改强度**：拖动滑块调整发型迁移的强度（0.1-1.0）
- **素描效果**：可选，勾选后会应用素描风格

### 5. 开始生成
- 点击"🚀 开始AI图生图发型迁移"按钮
- 等待AI处理（通常需要10-30秒）
- 查看生成的结果图片

### 6. 保存结果
- 点击"💾 下载生成结果"保存图片
- 或点击"🔄 重新开始"进行新的设计

---

## 🎨 新功能特性

### ✅ 单次添加模式
- 每次点击只添加一张图片
- 更加精确控制上传的图片
- 避免误选多张图片

### ✅ 数量限制（最多3张）
- 达到3张后按钮自动禁用
- 显示"已达上限(3/3)"提示
- 防止上传过多图片

### ✅ 单独删除功能
- 每张缩略图右上角有删除按钮
- 点击"×"可以删除单张图片
- 删除后可以继续添加新图片

### ✅ 实时状态反馈
- 显示"已添加 X/3 张人脸图片"
- 颜色变化：绿色（未满）→ 红色（已满）
- 按钮状态自动更新

---

## 🔧 常见问题

### Q1: 为什么还是显示"演示模式"？
**A**: 检查以下几点：
1. 确认设置的是 `BAILIAN_API_KEY` 而不是 `DASHSCOPE_API_KEY`
2. 在**同一个终端窗口**中先 `export` 再运行 `python app.py`
3. 或者将 export 命令写入 `~/.zshrc` 并执行 `source ~/.zshrc`

验证方法：
```bash
echo $BAILIAN_API_KEY
```
如果显示您的密钥，说明设置成功。

### Q2: 如何确认环境变量已永久生效？
**A**: 
```bash
# 1. 检查 ~/.zshrc 文件
cat ~/.zshrc | grep BAILIAN_API_KEY

# 2. 打开新终端窗口，检查变量
echo $BAILIAN_API_KEY
```

### Q3: 点击"添加人脸图片"没反应？
**A**: 
- 检查是否已添加3张图片（已达上限）
- 查看按钮是否显示"已达上限(3/3)"
- 如果需要添加新图片，先删除一张现有图片

### Q4: 如何删除已添加的图片？
**A**: 
- 鼠标悬停在缩略图上
- 点击右上角的红色"×"按钮
- 图片会立即删除，可以继续添加新图片

### Q5: 生成的图片在哪里？
**A**: 
- 生成后会在页面中显示
- 点击"💾 下载生成结果"保存到本地
- 默认文件名：`ai-hair-transfer-result.jpg`

---

## 📊 技术说明

### API配置
- **环境变量名**：`BAILIAN_API_KEY`
- **API端点**：`https://dashscope.aliyuncs.com/api/v1/services/aigc/image2image/image-synthesis`
- **模型**：阿里云百炼图生图

### 上传限制
- **文件格式**：PNG, JPG, JPEG
- **数量限制**：发型参考图1张，目标人脸最多3张
- **文件大小**：最大16MB

### 处理流程
1. 前端：用户上传图片 → 转换为base64
2. 前端：发送数据到后端（customer_faces数组）
3. 后端：选择第一张目标人脸图片
4. 后端：调用百炼API进行发型迁移
5. 后端：返回生成的图片（base64格式）
6. 前端：显示结果图片

---

## 📝 文件说明

- `app.py` - Flask后端主程序
- `templates/image2image_index.html` - 前端页面（已修复）
- `bailian_image2image.py` - 百炼API调用模块
- `start.sh` - 启动脚本（推荐使用）
- `API配置说明.md` - API密钥配置详细说明
- `使用指南.md` - 本文件

---

## 💡 使用建议

1. **首次使用**：建议先用演示模式测试界面功能
2. **正式使用**：配置API密钥后可生成真实的发型迁移效果
3. **多角度拍摄**：建议上传顾客的正面、侧面、背面照片（最多3张）
4. **调整强度**：建议从0.7开始，根据效果调整
5. **保存结果**：及时下载生成的图片，避免丢失

---

## 🆘 获取帮助

如果遇到问题：
1. 查看终端的错误日志
2. 检查浏览器控制台（F12）的错误信息
3. 确认网络连接正常
4. 验证API密钥是否有效

---

## 🎉 开始使用

现在您可以开始使用修复后的发型迁移应用了！

```bash
# 快速启动
cd hairstyle-transfer
export BAILIAN_API_KEY='sk-3b506952dc8847f2b46de0e2a8d303b0'
python app.py
```

然后访问 http://localhost:5001 开始设计发型！
